name: Android CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-test-snapshots:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # Optional: makes sure LFS is available; checkout@v4 usually handles it,
      # but this avoids flakiness on some runners.
      - name: Install Git LFS
        run: |
          git lfs install --local
          git lfs pull

      # ✅ Fail fast if any files that should be in LFS are not actually in LFS
      - name: Verify Git LFS tracked files are actually in LFS
        shell: bash
        run: |
          set -euo pipefail
          expected="$(mktemp)"
          actual="$(mktemp)"

          # Files that should be LFS-tracked based on .gitattributes filter=lfs
          git ls-files ':(attr:filter=lfs)' | sort > "$expected"

          # Files currently recorded by Git LFS
          git lfs ls-files -n | sort > "$actual"

          if ! diff -u "$expected" "$actual"; then
            echo >&2 ""
            echo >&2 "❌ Detected files that should be tracked by Git LFS but are not."
            echo >&2 "Fix:"
            echo >&2 "  1) Install LFS:  brew install git-lfs && git lfs install"
            echo >&2 "  2) Track patterns: git lfs track \"**/snapshots/**/*.png\""
            echo >&2 "  3) Re-add & recommit affected files (and .gitattributes), then push."
            exit 1
          fi

          echo "✅ Git LFS tracking looks correct."

      # ✅ Run unit tests without noisy stacktrace, capture outcome
      - name: Run unit tests
        id: unit_tests
        continue-on-error: true
        run: ./gradlew testDebugUnitTest --no-daemon --console=plain

      # ✅ Friendly summary in GitHub Actions "Summary" tab if unit tests fail
      - name: Summarize unit test failures
        if: steps.unit_tests.outcome == 'failure'
        shell: bash
        run: |
          set -euo pipefail

          echo "## ❌ Unit tests failed" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Download the **unit-test-reports** artifact and open the HTML report." >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Failing tests (top 50)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

          python3 - <<'PY' >> "$GITHUB_STEP_SUMMARY"
          import glob
          import xml.etree.ElementTree as ET

          files = glob.glob("app/build/test-results/testDebugUnitTest/*.xml")
          failures = []
          for f in files:
              root = ET.parse(f).getroot()
              for tc in root.findall(".//testcase"):
                  name = tc.attrib.get("name", "")
                  cls = tc.attrib.get("classname", "")
                  node = tc.find("failure") or tc.find("error")
                  if node is not None:
                      msg = (node.attrib.get("message") or "").strip()
                      first = (msg.splitlines()[0] if msg else "")[:160]
                      line = f"- {cls}.{name}"
                      if first:
                          line += f"  →  {first}"
                      failures.append(line)

          if not failures:
              print("No failing tests parsed from XML. Check the HTML report artifact for details.")
          else:
              print("\n".join(failures[:50]))
          PY

          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Tip: run locally with \`./gradlew testDebugUnitTest\` and open the report under \`app/build/reports/tests/\`." >> "$GITHUB_STEP_SUMMARY"

          echo ""
          echo "❌ Unit tests failed. See the Summary tab + unit-test-reports artifact."
          exit 1

      # ✅ Run Paparazzi snapshot verification without noisy stacktrace, capture outcome
      - name: Run Paparazzi snapshot verification
        id: paparazzi
        continue-on-error: true
        run: ./gradlew :app:verifyPaparazziDebug --no-daemon --console=plain

      # ✅ Friendly summary if Paparazzi verify fails
      - name: Summarize Paparazzi failure
        if: steps.paparazzi.outcome == 'failure'
        shell: bash
        run: |
          set -euo pipefail

          echo "## ❌ Paparazzi snapshot verification failed" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Download the **paparazzi-reports** artifact and open:" >> "$GITHUB_STEP_SUMMARY"
          echo "\`app/build/reports/paparazzi/**/index.html\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Fix locally:" >> "$GITHUB_STEP_SUMMARY"
          echo "- Update baselines: \`./gradlew :app:recordPaparazziDebug\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Re-verify: \`./gradlew :app:verifyPaparazziDebug\`" >> "$GITHUB_STEP_SUMMARY"

          echo ""
          echo "❌ Paparazzi verification failed. See the Summary tab + paparazzi-reports artifact."
          exit 1

      # Upload reports so you can open them from CI run page
      - name: Upload Unit Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-reports
          path: |
            app/build/reports/tests/
            app/build/test-results/

      - name: Upload Paparazzi Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: paparazzi-reports
          path: |
            app/build/reports/paparazzi/
